<div class="doc-header">
    <h1>üîì The Vulnerability</h1>
    <p>Deep dive into the multi-step access control flaw</p>
</div>

<div class="content-section">
    <h2>Vulnerability Classification</h2>
    <p>
        This vulnerability falls under several OWASP classifications:
    </p>
    <ul>
        <li><strong>OWASP Top 10 2021:</strong> A01 - Broken Access Control</li>
        <li><strong>CWE-285:</strong> Improper Authorization</li>
        <li><strong>CWE-862:</strong> Missing Authorization</li>
        <li><strong>CWE-863:</strong> Incorrect Authorization</li>
    </ul>

    <div class="info-box">
        <h4>‚ÑπÔ∏è Industry Impact</h4>
        <p>
            Broken Access Control moved to #1 in the OWASP Top 10 (2021), up from #5 in 2017.
            This reflects the prevalence and severity of these issues in modern applications.
        </p>
    </div>
</div>

<div class="content-section">
    <h2>Code Analysis</h2>
    
    <h3>Step 1 & 2: Properly Protected</h3>
    <p>The first two steps correctly implement access control:</p>
    
    <div class="code-block">
        <code><span class="comment">// admin.php (Step 1) - SECURE</span>
<span class="keyword">if</span> (!<span class="function">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">'user_id'</span>]) || <span class="variable">$_SESSION</span>[<span class="string">'role'</span>] !== <span class="string">'admin'</span>) {
    <span class="function">header</span>(<span class="string">"Location: login.php"</span>);
    <span class="keyword">exit</span>;
}

<span class="comment">// admin-roles.php (Step 2) - SECURE</span>
<span class="keyword">if</span> (!<span class="function">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">'user_id'</span>]) || <span class="variable">$_SESSION</span>[<span class="string">'role'</span>] !== <span class="string">'admin'</span>) {
    <span class="function">header</span>(<span class="string">"Location: login.php"</span>);
    <span class="keyword">exit</span>;
}</code>
    </div>

    <h3>Step 3: Vulnerable Endpoint</h3>
    <p>The confirmation step fails to verify admin role:</p>
    
    <div class="code-block">
        <code><span class="comment">// admin-confirm.php (Step 3) - VULNERABLE!</span>

<span class="comment">// Only checks if user is logged in (NOT if they're admin)</span>
<span class="keyword">if</span> (!<span class="function">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">'user_id'</span>])) {
    <span class="function">header</span>(<span class="string">"Location: login.php"</span>);
    <span class="keyword">exit</span>;
}

<span class="comment">// Proceeds to execute role change without authorization check!</span>
<span class="variable">$stmt</span> = <span class="variable">$conn</span>-><span class="function">prepare</span>(<span class="string">"UPDATE users SET role = ? WHERE username = ?"</span>);
<span class="variable">$stmt</span>-><span class="function">bind_param</span>(<span class="string">"ss"</span>, <span class="variable">$role</span>, <span class="variable">$username</span>);
<span class="variable">$stmt</span>-><span class="function">execute</span>();</code>
    </div>

    <div class="danger-box">
        <h4>üî¥ The Critical Flaw</h4>
        <p>
            The developer assumed that because Steps 1 and 2 check for admin role, Step 3
            would only receive requests from users who passed those checks. But HTTP is
            stateless‚Äîan attacker can send a request directly to Step 3!
        </p>
    </div>
</div>

<div class="content-section">
    <h2>Why Does This Happen?</h2>
    
    <h3>Developer Assumptions</h3>
    <p>This vulnerability typically arises from these flawed assumptions:</p>
    <ul>
        <li><strong>Sequential Flow Assumption:</strong> "Users must go through Steps 1 and 2 first"</li>
        <li><strong>UI-Based Security:</strong> "The confirmation button only appears after authorization"</li>
        <li><strong>Referrer Trust:</strong> "The request comes from our own form"</li>
        <li><strong>Parameter Obfuscation:</strong> "Users won't know what parameters to send"</li>
    </ul>

    <h3>The Reality</h3>
    <p>
        None of these provide actual security:
    </p>
    <ul>
        <li>HTTP requests can be sent directly to any endpoint</li>
        <li>Client-side UI restrictions are trivially bypassed</li>
        <li>Referrer headers can be spoofed or omitted</li>
        <li>Parameter names are easily discovered through observation</li>
    </ul>
</div>

<div class="content-section">
    <h2>Attack Surface Analysis</h2>
    <p>
        The vulnerable endpoint <code>admin-confirm.php</code> accepts the following parameters:
    </p>
    
    <table style="width: 100%; border-collapse: collapse; margin: 1rem 0;">
        <thead>
            <tr style="background: rgba(255, 68, 68, 0.2);">
                <th style="padding: 1rem; text-align: left; border: 1px solid #333; color: #ff6666;">Parameter</th>
                <th style="padding: 1rem; text-align: left; border: 1px solid #333; color: #ff6666;">Expected Value</th>
                <th style="padding: 1rem; text-align: left; border: 1px solid #333; color: #ff6666;">Purpose</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td style="padding: 1rem; border: 1px solid #333;"><code>username</code></td>
                <td style="padding: 1rem; border: 1px solid #333;">Any valid username</td>
                <td style="padding: 1rem; border: 1px solid #333;">Target user for role change</td>
            </tr>
            <tr>
                <td style="padding: 1rem; border: 1px solid #333;"><code>role</code></td>
                <td style="padding: 1rem; border: 1px solid #333;">admin | user</td>
                <td style="padding: 1rem; border: 1px solid #333;">New role to assign</td>
            </tr>
            <tr>
                <td style="padding: 1rem; border: 1px solid #333;"><code>action</code></td>
                <td style="padding: 1rem; border: 1px solid #333;">upgrade</td>
                <td style="padding: 1rem; border: 1px solid #333;">Action type identifier</td>
            </tr>
            <tr>
                <td style="padding: 1rem; border: 1px solid #333;"><code>confirmed</code></td>
                <td style="padding: 1rem; border: 1px solid #333;">true</td>
                <td style="padding: 1rem; border: 1px solid #333;">Confirmation flag</td>
            </tr>
        </tbody>
    </table>

    <p>
        An attacker only needs to know these parameter names and valid values to exploit
        the vulnerability. These can be discovered by:
    </p>
    <ul>
        <li>Observing the form submission as a legitimate admin</li>
        <li>Reading the HTML source of Step 2</li>
        <li>Fuzzing the endpoint with common parameter names</li>
    </ul>
</div>

<div class="content-section">
    <h2>Vulnerability Detection</h2>
    <p>During security testing, this vulnerability can be identified through:</p>
    
    <h3>Manual Testing</h3>
    <ol>
        <li>Map all endpoints in a multi-step process</li>
        <li>Identify which steps perform authorization checks</li>
        <li>Test each step independently with low-privileged accounts</li>
        <li>Look for steps that accept action parameters without verifying permissions</li>
    </ol>

    <h3>Automated Scanning</h3>
    <ul>
        <li>Authorization testing tools can send requests with different session tokens</li>
        <li>Comparing responses between admin and non-admin sessions</li>
        <li>Looking for successful state changes with unauthorized sessions</li>
    </ul>

    <div class="info-box">
        <h4>üí° Testing Tip</h4>
        <p>
            Use Burp Suite's "Compare Site Maps" feature to identify endpoints that behave
            differently for admin vs. regular users, then focus testing on those areas.
        </p>
    </div>
</div>
