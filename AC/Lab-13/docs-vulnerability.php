<div class="doc-header">
    <h1>The Vulnerability</h1>
    <p>Technical analysis of Referer-based access control flaws</p>
</div>

<div class="content-section">
    <h2>Vulnerability Classification</h2>
    <p>
        Referer-based access control falls under the category of <strong>Broken Access Control</strong> 
        vulnerabilities, specifically:
    </p>
    <ul>
        <li><strong>CWE-293:</strong> Using Referer Field for Authentication</li>
        <li><strong>CWE-284:</strong> Improper Access Control</li>
        <li><strong>OWASP Top 10 A01:2021:</strong> Broken Access Control</li>
    </ul>
</div>

<div class="content-section">
    <h2>Why Referer Cannot Be Trusted</h2>
    
    <h3>1. Client-Side Control</h3>
    <p>
        The Referer header is set by the client (browser or tool). While browsers typically set it 
        automatically based on navigation, attackers using intercepting proxies or custom tools 
        can set any value they choose.
    </p>
    
    <div class="code-block">
        <span class="code-label">cURL Example</span>
        <code>curl -X GET "http://target.com/admin-roles.php?action=upgrade&username=attacker" \
     -H "Cookie: session=attacker_session" \
     -H "Referer: http://target.com/admin"</code>
    </div>
    
    <h3>2. Privacy Features May Omit It</h3>
    <p>
        Modern browsers and privacy extensions can strip or modify the Referer header for 
        privacy reasons. Applications relying on Referer may fail unexpectedly when users have 
        privacy-enhancing features enabled.
    </p>
    
    <h3>3. HTTPS to HTTP Transitions</h3>
    <p>
        When navigating from an HTTPS page to an HTTP page, browsers typically omit the Referer 
        header to prevent leaking potentially sensitive URLs over unencrypted connections.
    </p>
    
    <h3>4. Referrer-Policy Header</h3>
    <p>
        Websites can control Referer behavior using the <code>Referrer-Policy</code> header, 
        which can cause the Referer to be absent or truncated in legitimate requests.
    </p>
</div>

<div class="content-section">
    <h2>Vulnerable Code Pattern</h2>
    
    <p>Here's the vulnerable pattern used in this lab:</p>
    
    <div class="code-block">
        <span class="code-label">Vulnerable PHP</span>
        <code>&lt;?php
// Must be logged in (but role not checked!)
if (!isset($_SESSION['user_id'])) {
    die('Please log in');
}

// VULNERABLE: Only checks Referer header
$referer = $_SERVER['HTTP_REFERER'] ?? '';

if (strpos($referer, '/admin') === false) {
    http_response_code(401);
    die('Unauthorized - Invalid Referer');
}

// Performs admin action without verifying admin role!
$newRole = ($_GET['action'] === 'upgrade') ? 'admin' : 'user';
$stmt = $conn->prepare("UPDATE users SET role = ? WHERE username = ?");
$stmt->bind_param("ss", $newRole, $_GET['username']);
$stmt->execute();
?&gt;</code>
    </div>
    
    <div class="info-box danger">
        <h4>ðŸ”¥ The Critical Flaw</h4>
        <p>
            The code verifies the user is logged in (<code>$_SESSION['user_id']</code>) but 
            <strong>never verifies that the logged-in user has admin privileges</strong>. It 
            assumes that if the Referer header points to the admin page, the user must be 
            authorized to perform admin actions.
        </p>
    </div>
</div>

<div class="content-section">
    <h2>Attack Surface Analysis</h2>
    
    <h3>What the Attacker Controls</h3>
    <ul>
        <li><strong>HTTP Headers:</strong> Including Referer, User-Agent, and custom headers</li>
        <li><strong>Request Parameters:</strong> Username, action, and any other parameters</li>
        <li><strong>Their Own Session:</strong> A valid session cookie for a non-privileged account</li>
    </ul>
    
    <h3>What the Attacker Cannot Control</h3>
    <ul>
        <li><strong>Server-Side Session Data:</strong> Their session is bound to their actual role</li>
        <li><strong>Database State:</strong> Until the vulnerable endpoint modifies it</li>
    </ul>
    
    <div class="diagram">
        <h4 style="color: #ff6666; margin-bottom: 1rem;">Trust Boundary Violation</h4>
        <div class="diagram-row">
            <div class="diagram-box" style="background: rgba(255, 100, 0, 0.2); border-color: orange;">
                Client-Controlled<br>
                <small>Headers, Params, Cookies</small>
            </div>
            <span class="diagram-arrow">â†’</span>
            <div class="diagram-box" style="background: rgba(0, 200, 0, 0.2); border-color: #00aa00;">
                Server-Side<br>
                <small>Session Data, Database</small>
            </div>
        </div>
        <p style="color: #888; margin-top: 1rem;">
            Security decisions must be based on server-side data,<br>
            never client-controlled inputs like the Referer header
        </p>
    </div>
</div>

<div class="content-section">
    <h2>Real-World Impact</h2>
    <p>
        This vulnerability can lead to:
    </p>
    <ul>
        <li><strong>Privilege Escalation:</strong> Regular users gain admin access</li>
        <li><strong>Unauthorized Data Modification:</strong> Attackers can modify any user's data</li>
        <li><strong>Account Takeover:</strong> If the endpoint can change passwords or disable accounts</li>
        <li><strong>Business Logic Bypass:</strong> Any action "protected" by Referer checks can be bypassed</li>
    </ul>
</div>
