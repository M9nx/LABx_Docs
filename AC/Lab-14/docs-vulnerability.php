<style>
    .doc-section h1 { font-size: 2.2rem; color: #ff4444; margin-bottom: 1rem; }
    .doc-section h2 { font-size: 1.5rem; color: #ff6666; margin: 2rem 0 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid rgba(255, 68, 68, 0.3); }
    .doc-section h3 { font-size: 1.2rem; color: #ff8888; margin: 1.5rem 0 0.75rem; }
    .doc-section p { color: #ccc; line-height: 1.8; margin-bottom: 1rem; }
    .doc-section ul, .doc-section ol { margin: 1rem 0 1rem 1.5rem; color: #ccc; }
    .doc-section li { margin-bottom: 0.5rem; line-height: 1.6; }
    .doc-section code { background: rgba(255, 68, 68, 0.15); padding: 0.2rem 0.5rem; border-radius: 4px; font-family: 'Consolas', monospace; font-size: 0.9rem; color: #ff8888; }
    .doc-section pre { background: #0d0d0d; border: 1px solid #333; border-radius: 10px; padding: 1.5rem; overflow-x: auto; margin: 1rem 0; }
    .doc-section pre code { background: none; padding: 0; color: #88ff88; font-size: 0.85rem; }
    .danger-box { background: rgba(255, 68, 68, 0.1); border: 1px solid rgba(255, 68, 68, 0.4); border-radius: 10px; padding: 1.5rem; margin: 1.5rem 0; }
    .danger-box h4 { color: #ff6666; margin-bottom: 0.5rem; }
    .info-box { background: rgba(0, 150, 255, 0.1); border: 1px solid rgba(0, 150, 255, 0.4); border-radius: 10px; padding: 1.5rem; margin: 1.5rem 0; }
    .info-box h4 { color: #00aaff; margin-bottom: 0.5rem; }
    .comparison-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1.5rem 0; }
    .vulnerable-code { background: rgba(255, 68, 68, 0.1); border: 1px solid rgba(255, 68, 68, 0.4); border-radius: 10px; padding: 1.5rem; }
    .secure-code { background: rgba(0, 200, 0, 0.1); border: 1px solid rgba(0, 200, 0, 0.4); border-radius: 10px; padding: 1.5rem; }
    .code-title { font-weight: bold; margin-bottom: 0.5rem; }
    .vulnerable-code .code-title { color: #ff6666; }
    .secure-code .code-title { color: #66ff66; }
    .flow-diagram { background: rgba(0, 0, 0, 0.5); border: 1px solid rgba(255, 68, 68, 0.3); border-radius: 10px; padding: 2rem; margin: 1.5rem 0; font-family: 'Consolas', monospace; font-size: 0.85rem; overflow-x: auto; }
    .check-item { display: flex; align-items: flex-start; gap: 1rem; padding: 1rem; margin: 0.5rem 0; border-radius: 8px; }
    .check-pass { background: rgba(0, 200, 0, 0.1); border-left: 3px solid #00cc00; }
    .check-fail { background: rgba(255, 68, 68, 0.1); border-left: 3px solid #ff4444; }
    .check-icon { font-size: 1.2rem; }
</style>

<div class="doc-section">
    <h1>Vulnerability Analysis</h1>
    <p>
        This section provides a deep technical analysis of the IDOR vulnerability in the banner deletion 
        endpoint, examining the vulnerable code, the data model, and why the authorization checks are 
        insufficient.
    </p>

    <h2>Data Model Overview</h2>
    <p>
        The application uses a hierarchical data model where managers own clients, clients contain 
        campaigns, and campaigns contain banners:
    </p>

    <div class="flow-diagram">
        <pre style="color: #88ff88; margin: 0; text-align: left;">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            Data Model Hierarchy                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                â”‚
â”‚  Manager A (ID: 1)                       Manager B (ID: 2)                     â”‚
â”‚       â”‚                                       â”‚                                â”‚
â”‚       â”œâ”€â”€ Client 1 (ID: 1)                    â”œâ”€â”€ Client 3 (ID: 3)             â”‚
â”‚       â”‚    â””â”€â”€ Campaign 1 (ID: 1)             â”‚    â””â”€â”€ Campaign 4 (ID: 4)      â”‚
â”‚       â”‚         â”œâ”€â”€ Banner 1                  â”‚         â”œâ”€â”€ Banner 6 â—„â”€â”€â”      â”‚
â”‚       â”‚         â”œâ”€â”€ Banner 2                  â”‚         â”œâ”€â”€ Banner 7    â”‚      â”‚
â”‚       â”‚         â””â”€â”€ Banner 3                  â”‚         â””â”€â”€ Banner 8    â”‚      â”‚
â”‚       â”‚                                       â”‚                         â”‚      â”‚
â”‚       â””â”€â”€ Client 2 (ID: 2)                    â””â”€â”€ Client 4 (ID: 4)      â”‚      â”‚
â”‚            â””â”€â”€ Campaign 2 (ID: 2)                  â”œâ”€â”€ Campaign 5       â”‚      â”‚
â”‚                 â”œâ”€â”€ Banner 4                       â”‚    â””â”€â”€ Banner 9    â”‚      â”‚
â”‚                 â””â”€â”€ Banner 5                       â””â”€â”€ Campaign 6       â”‚      â”‚
â”‚                                                         â”œâ”€â”€ Banner 10  â”‚      â”‚
â”‚                                                         â””â”€â”€ Banner 11  â”‚      â”‚
â”‚                                                                         â”‚      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚  Attack Vector: Manager A deletes Manager B's banners (6-11)                  â”‚
â”‚                 by providing valid clientid/campaignid from their own data    â”‚
â”‚                                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        </pre>
    </div>

    <h2>Vulnerable Code Analysis</h2>
    <p>
        The <code>banner-delete.php</code> endpoint performs authorization checks, but there's a critical 
        gap in the validation logic:
    </p>

    <pre><code class="language-php">// banner-delete.php - VULNERABLE CODE

// Step 1: Get parameters from request
$clientId = $_GET['clientid'];
$campaignId = $_GET['campaignid'];
$bannerId = $_GET['bannerid'];

// Step 2: Verify CSRF token (Security âœ“)
if (!validateCsrfToken($token)) {
    die("CSRF validation failed");
}

// Step 3: CHECK - User has access to client (Security âœ“)
$stmt = $pdo->prepare("
    SELECT c.client_id 
    FROM clients c 
    WHERE c.client_id = ? AND c.manager_id = ?
");
$stmt->execute([$clientId, $_SESSION['manager_id']]);
if (!$stmt->fetch()) {
    die("Access denied to client");  // This check PASSES for attacker's own client
}

// Step 4: CHECK - Campaign belongs to client (Security âœ“)
$stmt = $pdo->prepare("
    SELECT campaign_id 
    FROM campaigns 
    WHERE campaign_id = ? AND client_id = ?
");
$stmt->execute([$campaignId, $clientId]);
if (!$stmt->fetch()) {
    die("Invalid campaign");  // This check PASSES for attacker's own campaign
}

// Step 5: DELETE - No check that banner belongs to campaign! (VULNERABILITY âœ—)
$stmt = $pdo->prepare("DELETE FROM banners WHERE banner_id = ?");
$stmt->execute([$bannerId]);  // Deletes ANY banner by ID, regardless of ownership!</code></pre>

    <h2>Authorization Check Analysis</h2>
    
    <div class="check-item check-pass">
        <span class="check-icon">âœ…</span>
        <div>
            <strong>Check 1: Client Access Validation</strong><br>
            <span style="color: #888;">Verifies the user's manager_id has access to the specified clientid. This passes when an attacker uses their own client ID.</span>
        </div>
    </div>

    <div class="check-item check-pass">
        <span class="check-icon">âœ…</span>
        <div>
            <strong>Check 2: Campaign-Client Relationship</strong><br>
            <span style="color: #888;">Verifies the campaignid belongs to the clientid. This passes when an attacker uses their own campaign ID.</span>
        </div>
    </div>

    <div class="check-item check-fail">
        <span class="check-icon">âŒ</span>
        <div>
            <strong>Check 3: Banner-Campaign Relationship (MISSING!)</strong><br>
            <span style="color: #888;">Should verify that bannerid belongs to campaignid, but this check doesn't exist! The banner is deleted purely by ID.</span>
        </div>
    </div>

    <div class="danger-box">
        <h4>ğŸ”“ The Core Vulnerability</h4>
        <p>
            The attacker passes their own valid <code>clientid</code> and <code>campaignid</code> to pass 
            the authorization checks, but substitutes the <code>bannerid</code> with a victim's banner ID. 
            Since banner ownership is never verified, the deletion succeeds!
        </p>
    </div>

    <h2>Attack Flow</h2>

    <div class="flow-diagram">
        <pre style="color: #88ff88; margin: 0; text-align: left;">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              IDOR Attack Flow                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  1. Attacker (Manager A) logs in with: manager_a:attacker123                     â”‚
â”‚                                                                                  â”‚
â”‚  2. Navigates to own campaign banners, notes delete URL structure:               â”‚
â”‚     banner-delete.php?token=ABC&clientid=1&campaignid=1&bannerid=1              â”‚
â”‚                                                                                  â”‚
â”‚  3. Identifies victim's banner IDs through enumeration: 6, 7, 8, 9, 10, 11       â”‚
â”‚                                                                                  â”‚
â”‚  4. Crafts malicious request:                                                    â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚     â”‚ banner-delete.php?token=ABC&clientid=1&campaignid=1&bannerid=6         â”‚  â”‚
â”‚     â”‚                                                                        â”‚  â”‚
â”‚     â”‚ â€¢ token=ABC      â†’ Attacker's valid CSRF token (from session)         â”‚  â”‚
â”‚     â”‚ â€¢ clientid=1     â†’ Attacker's client (passes CHECK 1) âœ“               â”‚  â”‚
â”‚     â”‚ â€¢ campaignid=1   â†’ Attacker's campaign (passes CHECK 2) âœ“             â”‚  â”‚
â”‚     â”‚ â€¢ bannerid=6     â†’ VICTIM'S banner! (NO CHECK EXISTS!) âš ï¸              â”‚  â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                  â”‚
â”‚  5. Server processes request:                                                    â”‚
â”‚     - Validates CSRF token âœ“                                                     â”‚
â”‚     - Validates client access âœ“                                                  â”‚
â”‚     - Validates campaign belongs to client âœ“                                     â”‚
â”‚     - Deletes banner without ownership check! âœ—                                  â”‚
â”‚                                                                                  â”‚
â”‚  6. Banner #6 (belonging to Manager B) is deleted!                               â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        </pre>
    </div>

    <h2>Vulnerable vs Secure Code</h2>

    <div class="comparison-grid">
        <div class="vulnerable-code">
            <div class="code-title">âŒ Vulnerable Implementation</div>
            <pre><code>// Missing banner ownership check
$stmt = $pdo->prepare("
    DELETE FROM banners 
    WHERE banner_id = ?
");
$stmt->execute([$bannerId]);

// Banner deleted without verifying 
// it belongs to the campaign!</code></pre>
        </div>

        <div class="secure-code">
            <div class="code-title">âœ… Secure Implementation</div>
            <pre><code>// Verify banner belongs to campaign
$stmt = $pdo->prepare("
    DELETE FROM banners 
    WHERE banner_id = ? 
    AND campaign_id = ?
");
$stmt->execute([$bannerId, $campaignId]);

// Banner only deleted if it belongs
// to the authenticated campaign</code></pre>
        </div>
    </div>

    <h2>Why This Pattern is Common</h2>
    <p>
        Developers often make this mistake for several reasons:
    </p>
    <ul>
        <li><strong>Assumed Transitive Authorization:</strong> "If I can access the campaign, surely I can access its banners"</li>
        <li><strong>UI-Based Security:</strong> "The UI only shows delete links for user's own banners"</li>
        <li><strong>Parameter Trust:</strong> "The campaignid comes from a link I generated, so banner must belong to it"</li>
        <li><strong>Hierarchical Confusion:</strong> "I validated the parent, so children are implicitly authorized"</li>
    </ul>

    <div class="info-box">
        <h4>ğŸ’¡ Key Takeaway</h4>
        <p>
            Authorization must be verified at <strong>every level</strong> of object access. Validating 
            access to a parent object does NOT grant access to all children. Each object ID in a request 
            must be independently verified against the authenticated user's permissions.
        </p>
    </div>
</div>
